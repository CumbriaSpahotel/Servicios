<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Hotel Cumbria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Cumbria Admin</h1>

            <a href="index.html"
                class="flex items-center gap-2 px-4 py-2 bg-stone-200 rounded-lg text-stone-700 font-bold hover:bg-stone-300 transition text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 3h6v6" />
                    <path d="M10 14 21 3" />
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                </svg>
                Ir a la App
            </a>
        </div>

        <!-- TABS -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="switchTab('restaurante')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="restaurante">Restaurante</button>
            <button onclick="switchTab('roomService')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="roomService">Room Service</button>
            <button onclick="switchTab('cafeteria')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="cafeteria">Cafetería</button>
            <button onclick="switchTab('minibar')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="minibar">Minibar</button>
            <button onclick="switchTab('laundry')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="laundry">Lavandería</button>
            <button onclick="switchTab('spa')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="spa">Spa</button>
            <button onclick="switchTab('tourism')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="tourism">Turismo</button>
            <button onclick="switchTab('info')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="info">Info</button>
        </div>

        <!-- EDITOR AREA -->
        <div id="editor-area" class="bg-white p-6 rounded-2xl shadow-lg pb-24">
            <!-- Dynamic Form -->
        </div>

        <button onclick="saveChanges()"
            class="fixed bottom-6 right-6 bg-emerald-600 text-white p-4 rounded-full shadow-2xl hover:bg-emerald-700 transition transform hover:scale-105 flex items-center gap-2 z-50">
            <i data-lucide="save" class="w-6 h-6"></i>
            <span class="font-bold">GUARDAR CAMBIOS</span>
        </button>
    </div>

    <script src="firebase-config.js"></script>
    <script type="module" src="db.js"></script>
    <script type="module">
        import { DB } from './db.js';

        // Globals needed for HTML onclick handlers and appData binding
        window.appData = null;
        window.currentTab = 'restaurante';

        // Initialize icons
        lucide.createIcons();

        // Initialize App
        (async function init() {
            const editor = document.getElementById('editor-area');
            if (editor) editor.innerHTML = '<div class="text-center p-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i><p>Cargando datos...</p></div>';

            window.appData = await DB.get();
            switchTab(window.currentTab);
        })();

        // --- GLOBAL FUNCTIONS ---

        window.switchTab = function (tab) {
            window.currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('bg-amber-500', 'text-white');
                b.classList.add('bg-white', 'text-gray-800');
                if (b.dataset.tab === tab) {
                    b.classList.remove('bg-white', 'text-gray-800');
                    b.classList.add('bg-amber-500', 'text-white');
                }
            });
            renderEditor();
        }

        window.renderEditor = function () {
            const container = document.getElementById('editor-area');
            const data = window.appData[window.currentTab];

            if (!data) {
                container.innerHTML = `<p class="text-red-500">Error: No se encontraron datos para la pestaña ${window.currentTab}. Intenta reiniciar los datos.</p>`;
                return;
            }

            let html = '';

            // Master Toggle (Active/Inactive)
            html += `
                <div class="mb-6 p-4 bg-stone-50 rounded-xl border border-stone-200 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">Visible en App</h3>
                        <p class="text-xs text-gray-500">Activar o desactivar este servicio para los huéspedes</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" 
                               ${data.active ? 'checked' : ''} 
                               onchange="appData.${window.currentTab}.active = this.checked; saveChanges();" 
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                    </label>
                </div>
            `;

            // Common Fields
            if (data.desc !== undefined && window.currentTab !== 'minibar' && window.currentTab !== 'laundry') html += field('Descripción', `appData.${window.currentTab}.desc`, data.desc, 'textarea');
            if (data.info !== undefined && window.currentTab === 'laundry') html += field('Información', `appData.${window.currentTab}.info`, data.info, 'textarea');
            if (data.schedule !== undefined) html += field('Horario', `appData.${window.currentTab}.schedule`, data.schedule);
            if (data.ext !== undefined) html += field('Extensión Telefónica', `appData.${window.currentTab}.ext`, data.ext);
            if (data.surcharge !== undefined) html += field('Suplemento (€)', `appData.${window.currentTab}.surcharge`, data.surcharge);

            // Special: Tourism
            if (window.currentTab === 'tourism') {
                html += `<div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                            <h3 class="font-bold text-lg mb-4 text-amber-600 border-b border-amber-200 pb-2">Contenido Principal</h3>
                            ${field('Descripción de la Guía', `appData.tourism.desc`, data.desc || '', 'textarea')}
                         </div>`;

                html += `<div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                            <h3 class="font-bold text-lg mb-4 text-blue-600 border-b border-blue-200 pb-2">Videos Destacados</h3>
                            
                            <div class="mb-4">
                                ${field('Video Principal (Cabecera - Spa)', `appData.tourism.videoUrl`, data.videoUrl)}
                                <p class="text-xs text-gray-500 -mt-2 mb-2">Se muestra en grande al inicio de la página.</p>
                            </div>

                            <div class="mb-4">
                                ${field('Video Promocional (Contenido - Turismo)', `appData.tourism.videoUrlPromo`, data.videoUrlPromo || '')}
                                <p class="text-xs text-gray-500 -mt-2 mb-2">Se muestra pequeño junto al texto descriptivo.</p>
                            </div>
                            
                            <p class="text-xs text-gray-400 italic">Usar formato embed de YouTube: https://www.youtube.com/embed/VIDEO_ID</p>
                         </div>`;
            }

            // Special: Spa Prices
            if (window.currentTab === 'spa') {
                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Tarifas</h3>`;
                html += field('Semana', `appData.spa.prices.week`, data.prices.week);
                html += field('Fin de Semana', `appData.spa.prices.weekend`, data.prices.weekend);
                html += field('Gorro', `appData.spa.prices.cap`, data.prices.cap);
                html += field('Chanclas', `appData.spa.prices.flipflops`, data.prices.flipflops);
            }

            // Special: Info
            if (window.currentTab === 'info') {
                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Recepción</h3>`;
                html += field('Texto', `appData.info.reception.text`, data.reception.text, 'textarea');
                html += field('Teléfono', `appData.info.reception.phone`, data.reception.phone);

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Desayuno</h3>`;
                html += field('Horario Semana', `appData.info.breakfast.schedule_week`, data.breakfast.schedule_week);
                html += field('Horario Finde', `appData.info.breakfast.schedule_weekend`, data.breakfast.schedule_weekend);
                html += field('Precio', `appData.info.breakfast.price`, data.breakfast.price);

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Piscina & Gym</h3>`;
                html += field('Piscina Desc.', `appData.info.pool.text`, data.pool.text);
                html += field('Piscina Horario', `appData.info.pool.schedule`, data.pool.schedule);
                html += field('Gym Desc.', `appData.info.gym.text`, data.gym.text);
                html += field('Gym Horario Sem.', `appData.info.gym.schedule_week`, data.gym.schedule_week);

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Parking</h3>`;
                html += field('Texto', `appData.info.parking.text`, data.parking.text, 'textarea');

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Otros Horarios</h3>`;
                html += field('Rest. Comidas', `appData.info.restaurant.schedule_lunch`, data.restaurant.schedule_lunch);
                html += field('Rest. Cenas', `appData.info.restaurant.schedule_dinner`, data.restaurant.schedule_dinner);
                html += field('Cafetería', `appData.info.cafeteria.schedule`, data.cafeteria.schedule);
                html += field('Room Service', `appData.info.roomService.schedule`, data.roomService.schedule);
            }

            // Categories & Items (Restaurant, Room Service, Minibar)
            if (window.currentTab === 'restaurante') {
                const menu = data.dailyMenu || { active: false, price: '', date: '', includes: '', starters: [], mains: [] };

                // Ensure data structure
                if (!window.appData.restaurante.dailyMenu) {
                    window.appData.restaurante.dailyMenu = {
                        active: false,
                        price: "20,00",
                        date: "",
                        includes: "Incluido postre, pan, y una bebida\n(Agua, refresco, copa de vino o caña)",
                        starters: [],
                        mains: []
                    };
                }

                html += `
                    <div class="mt-8 mb-8 border-2 border-stone-800 rounded-xl p-6 bg-stone-50">
                        <div class="flex justify-between items-center mb-6 border-b border-stone-200 pb-4">
                            <h3 class="font-bold text-2xl font-serif text-stone-900">Configuración Menú del Día</h3>
                             
                             <div class="flex gap-4">
                                <!-- Helper: Activar Carta -->
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           ${data.showCarta !== false ? 'checked' : ''} 
                                           onchange="appData.restaurante.showCarta = this.checked; saveChanges();" 
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-stone-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-900">Mostrar Carta</span>
                                </label>

                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           ${menu.active ? 'checked' : ''} 
                                           onchange="appData.restaurante.dailyMenu.active = this.checked; saveChanges();" 
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-stone-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-stone-800"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-900">Activar Menú</span>
                                </label>
                             </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4 relative">
                            <div>
                                ${field('Fecha (Texto)', `appData.restaurante.dailyMenu.date`, menu.date)}
                                <button onclick="setTodayDate()" class="absolute top-[34px] right-[52%] text-xs bg-stone-200 hover:bg-stone-300 px-2 py-1 rounded">Hoy</button>
                            </div>
                            <div class="relative">
                                ${field('Precio (€)', `appData.restaurante.dailyMenu.price`, menu.price)}
                                <a href="https://translate.google.com/" target="_blank" class="absolute top-[34px] right-2 text-xs text-amber-600 hover:underline flex items-center gap-1"><i data-lucide="languages" class="w-3 h-3"></i> Traducir</a>
                            </div>
                        </div>

                        <div class="mb-4">
                             <label class="block text-sm font-bold text-gray-600 mb-1">Primeros Platos (Uno por línea)</label>
                             <textarea rows="6" onchange="updateMenuArray('starters', this.value)" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-stone-500 font-mono text-sm">${(menu.starters || []).join('\n')}</textarea>
                        </div>

                        <div class="mb-4">
                             <label class="block text-sm font-bold text-gray-600 mb-1">Segundos Platos (Uno por línea)</label>
                             <textarea rows="6" onchange="updateMenuArray('mains', this.value)" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-stone-500 font-mono text-sm">${(menu.mains || []).join('\n')}</textarea>
                        </div>
                        
                         <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-600 mb-1">Incluye (Texto al pie)</label>
                            <textarea rows="2" onchange="appData.restaurante.dailyMenu.includes = this.value" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-stone-500">${menu.includes || ''}</textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded text-xs text-blue-800">
                            <strong>Nota:</strong> Los números entre paréntesis, ej: (1/4), se mostrarán automáticamente en la app como alérgenos.
                        </div>
                    </div>
                `;
            }

            // Categories & Items (Restaurant, Room Service, Minibar)
            if (data.categories && window.currentTab !== 'laundry') {
                html += `<div id="sortable-categories">`;
                data.categories.forEach((cat, catIdx) => {
                    html += `
                        <div class="mt-8 border p-4 rounded-xl bg-gray-50 relative group sortable-category" data-id="${catIdx}">
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 cursor-grab handle-cat hover:text-amber-500"></i>
                                <input value="${cat.name}" onchange="appData.${window.currentTab}.categories[${catIdx}].name = this.value" class="font-bold text-lg text-amber-600 bg-transparent border-b border-transparent focus:border-amber-500 focus:outline-none flex-1">
                                <button onclick="deleteCategory(${catIdx})" class="text-xs text-red-300 hover:text-red-500 transition px-2 py-1 rounded hover:bg-red-50" title="Eliminar Categoría">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <div class="space-y-4 sortable-items" data-cat="${catIdx}">
                                ${cat.items.map((item, itemIdx) => itemRow(window.currentTab, catIdx, itemIdx, item)).join('')}
                            </div>

                            <button onclick="addItem(${catIdx})" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-amber-500 hover:text-amber-500 transition flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Añadir Plato
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Special: Laundry Categories
            if (data.categories && window.currentTab === 'laundry') {
                html += `<div id="sortable-categories">`;
                data.categories.forEach((cat, catIdx) => {
                    html += `
                        <div class="mt-8 border p-4 rounded-xl bg-gray-50 relative group sortable-category" data-id="${catIdx}">
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 cursor-grab handle-cat hover:text-blue-500"></i>
                                <input value="${cat.name}" onchange="appData.laundry.categories[${catIdx}].name = this.value" class="font-bold text-lg text-blue-600 bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none flex-1">
                                <button onclick="deleteCategory(${catIdx})" class="text-xs text-red-300 hover:text-red-500 transition px-2 py-1 rounded hover:bg-red-50" title="Eliminar Categoría">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-400 mb-2 px-2 pl-8">
                                <div class="col-span-1"></div>
                                <div class="col-span-5">Prenda</div>
                                <div class="col-span-3 text-right">Lav+Plan</div>
                                <div class="col-span-3 text-right">Plancha</div>
                            </div>
                            <div class="space-y-2 sortable-items" data-cat="${catIdx}">
                                ${cat.items.map((item, itemIdx) => itemRowLaundry(catIdx, itemIdx, item)).join('')}
                            </div>
                            <button onclick="addLaundryItem(${catIdx})" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-blue-500 hover:text-blue-500 transition flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Añadir Prenda
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Simple Items List (Cafeteria)
            if (data.items && window.currentTab !== 'laundry') {
                html += `
                    <div class="mt-8 border p-4 rounded-xl bg-gray-50">
                        <h3 class="font-bold text-lg text-amber-600 mb-2">Artículos</h3>
                        <div class="space-y-4 sortable-list" id="simple-items-list">
                            ${data.items.map((item, itemIdx) => itemRowSimple(window.currentTab, itemIdx, item)).join('')}
                        </div>
                        <button onclick="addItemSimple()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-amber-500 hover:text-amber-500 transition flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Añadir Artículo
                        </button>
                    </div>
                `;
            }

            // ADD CATEGORY BUTTON (New)
            if (data.categories) {
                html += `
                    <div class="mt-8 border-t pt-6">
                        <button onclick="addCategory()" class="w-full py-3 bg-stone-100 rounded-xl text-stone-600 font-bold hover:bg-stone-200 transition flex items-center justify-center gap-2">
                             <i data-lucide="folder-plus" class="w-5 h-5"></i> Crear Nueva Categoría
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
            lucide.createIcons();
            initSortable();
        }

        window.initSortable = function () {
            // Sort Categories
            const catContainer = document.getElementById('sortable-categories');
            if (catContainer) {
                new Sortable(catContainer, {
                    animation: 150,
                    handle: '.handle-cat',
                    onEnd: function (evt) {
                        const tab = window.currentTab;
                        const arr = window.appData[tab].categories;
                        // Move item in array and Update
                        const [movedItem] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, movedItem);
                        renderEditor(); // Re-render to update indices
                    }
                });
            }

            // Sort Items within Categories
            document.querySelectorAll('.sortable-items').forEach(el => {
                const catIdx = el.dataset.cat;
                new Sortable(el, {
                    animation: 150,
                    handle: '.handle-item',
                    onEnd: function (evt) {
                        const tab = window.currentTab;
                        if (!window.appData[tab].categories[catIdx]) return; // Safety check

                        const arr = window.appData[tab].categories[catIdx].items;
                        const [movedItem] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, movedItem);
                        renderEditor();
                    }
                });
            });

            // Sort Simple List
            const simpleList = document.getElementById('simple-items-list');
            if (simpleList) {
                new Sortable(simpleList, {
                    animation: 150,
                    handle: '.handle-item',
                    onEnd: function (evt) {
                        const tab = window.currentTab;
                        const arr = window.appData[tab].items;
                        const [movedItem] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, movedItem);
                        renderEditor();
                    }
                });
            }
        }

        window.field = function (label, path, value, type = 'text') {
            return `
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-600 mb-1">${label}</label>
                    <input type="${type}" value="${value}" onchange="${path} = this.value" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-amber-500 options-input">
                </div>
            `;
        }

        // --- ROW TEMPLATES ---

        window.itemRow = function (tab, catIdx, itemIdx, item) {
            return `
                <div class="flex gap-2 items-start bg-white p-2 rounded shadow-sm group/item">
                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 mt-3 cursor-grab handle-item hover:text-amber-500"></i>
                    <div class="flex-1 space-y-2">
                        <input placeholder="Nombre" value="${item.name}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].name = this.value" class="w-full font-bold border-b mb-1 focus:outline-none focus:border-amber-500">
                        <div class="flex gap-2">
                             <input placeholder="Descripción" value="${item.desc || ''}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].desc = this.value" class="flex-1 text-sm text-gray-500 focus:outline-none focus:text-gray-800 border-b border-transparent hover:border-gray-200">
                             <input placeholder="Alérgenos (ej: 1,4)" value="${item.allergens || ''}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].allergens = this.value" class="w-32 text-xs text-gray-500 focus:outline-none focus:text-amber-600 border-b border-transparent hover:border-amber-200 text-right" title="Códigos de alérgenos">
                        </div>
                        <div class="flex gap-2 items-center">
                            <i data-lucide="image" class="w-3 h-3 text-gray-300"></i>
                            <input placeholder="URL Imagen (opcional)" value="${item.image || ''}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].image = this.value" class="flex-1 text-xs text-stone-400 focus:outline-none focus:text-blue-600 border-b border-transparent hover:border-blue-200">
                        </div>
                    </div>
                    <div class="w-24">
                        <input type="text" value="${item.price}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].price = this.value" class="w-full p-1 border rounded text-right font-mono focus:ring-2 focus:ring-amber-500" placeholder="0.00">
                    </div>
                    <button onclick="deleteItem(${catIdx}, ${itemIdx})" class="p-2 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        window.itemRowSimple = function (tab, itemIdx, item) {
            return `
                <div class="flex gap-2 items-start bg-white p-2 rounded shadow-sm group/item">
                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 mt-3 cursor-grab handle-item hover:text-amber-500"></i>
                    <div class="flex-1">
                        <input placeholder="Nombre" value="${item.name}" onchange="appData.${tab}.items[${itemIdx}].name = this.value" class="w-full font-bold border-b mb-1 focus:outline-none focus:border-amber-500">
                    </div>
                    <div class="w-24">
                        <input type="text" value="${item.price}" onchange="appData.${tab}.items[${itemIdx}].price = this.value" class="w-full p-1 border rounded text-right font-mono focus:ring-2 focus:ring-amber-500" placeholder="0.00">
                    </div>
                    <button onclick="deleteItemSimple(${itemIdx})" class="p-2 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        window.itemRowLaundry = function (catIdx, itemIdx, item) {
            return `
                <div class="grid grid-cols-12 gap-1 items-center bg-white p-2 rounded shadow-sm">
                    <div class="col-span-1 flex justify-center">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 cursor-grab handle-item hover:text-blue-500"></i>
                    </div>
                    <div class="col-span-5">
                        <input value="${item.name}" onchange="appData.laundry.categories[${catIdx}].items[${itemIdx}].name = this.value" class="w-full font-bold text-sm bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none" placeholder="Nombre">
                    </div>
                    <div class="col-span-3">
                        <input value="${item.priceWash}" onchange="appData.laundry.categories[${catIdx}].items[${itemIdx}].priceWash = this.value" class="w-full text-right text-xs font-mono bg-blue-50/50 rounded px-1 py-1 border border-transparent focus:border-blue-500" type="text" placeholder="Lav">
                    </div>
                    <div class="col-span-2">
                        <input value="${item.priceIron}" onchange="appData.laundry.categories[${catIdx}].items[${itemIdx}].priceIron = this.value" class="w-full text-right text-xs font-mono bg-stone-50 rounded px-1 py-1 border border-transparent focus:border-blue-500" type="text" placeholder="Pla">
                    </div>
                    <div class="col-span-1 text-center">
                         <button onclick="deleteLaundryItem(${catIdx}, ${itemIdx})" class="p-1 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---

        window.addCategory = function () {
            const name = prompt("Nombre de la nueva categoría:");
            if (name) {
                window.appData[window.currentTab].categories.push({
                    name: name,
                    items: []
                });
                renderEditor();
            }
        }

        window.deleteCategory = function (catIdx) {
            if (confirm("¿Estás seguro de eliminar esta categoría y todos sus ítems?")) {
                window.appData[window.currentTab].categories.splice(catIdx, 1);
                renderEditor();
            }
        }

        window.addItem = function (catIdx) {
            const newItem = { name: "Nuevo Plato", desc: "Descripción...", price: "0.00" };
            window.appData[window.currentTab].categories[catIdx].items.push(newItem);
            renderEditor();
        }

        window.deleteItem = function (catIdx, itemIdx) {
            if (confirm('¿Eliminar este plato?')) {
                window.appData[window.currentTab].categories[catIdx].items.splice(itemIdx, 1);
                renderEditor();
            }
        }

        window.addLaundryItem = function (catIdx) {
            const newItem = { name: "Nueva Prenda", priceWash: "0,00", priceIron: "0,00" };
            window.appData.laundry.categories[catIdx].items.push(newItem);
            renderEditor();
        }

        window.deleteLaundryItem = function (catIdx, itemIdx) {
            if (confirm('¿Eliminar esta prenda?')) {
                window.appData.laundry.categories[catIdx].items.splice(itemIdx, 1);
                renderEditor();
            }
        }

        window.addItemSimple = function () {
            const newItem = { name: "Nuevo Artículo", price: "0.00" };
            window.appData[window.currentTab].items.push(newItem);
            renderEditor();
        }

        window.deleteItemSimple = function (itemIdx) {
            if (confirm('¿Eliminar este artículo?')) {
                window.appData[window.currentTab].items.splice(itemIdx, 1);
                renderEditor();
            }
        }

        window.saveChanges = async function () {
            const btn = document.querySelector('button[onclick="saveChanges()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> Guardando...';

            try {
                // Save Main Data
                await DB.save(window.appData);

                // Save History if we are in Restaurant tab

                if (window.currentTab === 'restaurante' && window.appData.restaurante.dailyMenu.active) {
                    await DB.saveMenuHistory(window.appData.restaurante.dailyMenu);
                }

                alert('¡Cambios guardados! Sincronizado con la nube.');
            } catch (err) {
                console.error(err);
                alert('Error al guardar: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        window.setTodayDate = function () {
            const date = new Date();
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Format: "Ciudad Real, 11 de Enero de 2026"
            const str = `Ciudad Real, ${date.getDate()} de ${months[date.getMonth()]} de ${date.getFullYear()}`;

            // Update Data
            if (window.appData && window.appData.restaurante && window.appData.restaurante.dailyMenu) {
                window.appData.restaurante.dailyMenu.date = str;
            }

            // Update Input View: Find input that syncs with dailyMenu.date
            // Re-render essentially
            renderEditor();
        }

        window.updateMenuArray = function (key, value) {
            // Split by newline and remove empty lines
            const arr = value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            window.appData.restaurante.dailyMenu[key] = arr;
        }

        window.resetData = function () {
            if (confirm('¿Reiniciar todos los datos a fábrica?')) {
                window.appData = DB.reset();
                renderEditor();
            }
        }
    </script>
</body>

</html>