<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Hotel Cumbria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Cumbria Admin</h1>

            <a href="index.html"
                class="flex items-center gap-2 px-4 py-2 bg-stone-200 rounded-lg text-stone-700 font-bold hover:bg-stone-300 transition text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 3h6v6" />
                    <path d="M10 14 21 3" />
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                </svg>
                Ir a la App
            </a>
        </div>

        <!-- TABS -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="switchTab('restaurante')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="restaurante">Restaurante</button>
            <button onclick="switchTab('roomService')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="roomService">Room Service</button>
            <button onclick="switchTab('cafeteria')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="cafeteria">Cafeter√≠a</button>
            <button onclick="switchTab('minibar')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="minibar">Minibar</button>
            <button onclick="switchTab('laundry')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="laundry">Lavander√≠a</button>
            <button onclick="switchTab('spa')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="spa">Spa</button>
            <button onclick="switchTab('tourism')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="tourism">Turismo</button>
            <button onclick="switchTab('info')"
                class="tab-btn px-4 py-2 bg-white rounded-lg shadow-sm font-bold hover:bg-amber-50"
                data-tab="info">Info</button>
        </div>

        <!-- EDITOR AREA -->
        <div id="editor-area" class="bg-white p-6 rounded-2xl shadow-lg pb-24">
            <!-- Dynamic Form -->
        </div>

        <button onclick="saveChanges()"
            class="fixed bottom-6 right-6 bg-emerald-600 text-white p-4 rounded-full shadow-2xl hover:bg-emerald-700 transition transform hover:scale-105 flex items-center gap-2 z-50">
            <i data-lucide="save" class="w-6 h-6"></i>
            <span class="font-bold">GUARDAR CAMBIOS</span>
        </button>
    </div>

    <script src="firebase-config.js"></script>
    <script type="module" src="db.js"></script>
    <script type="module">
        import { DB } from './db.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Initialize separate app instance for Storage if needed, or share config
        const app = initializeApp(window.firebaseConfig, "StorageApp");
        const storage = getStorage(app);

        // Globals needed for HTML onclick handlers and appData binding
        window.appData = null;
        window.currentTab = 'restaurante';

        // Initialize icons
        lucide.createIcons();

        // --- UPLOAD FUNCTION ---
        window.triggerUpload = function (fieldPath) {
            // Create a temp invisible file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const btn = document.getElementById(`btn-${fieldPath}`);
                if (btn) btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Subiendo...';
                if (window.lucide) window.lucide.createIcons();

                try {
                    // Path: uploads/{timestamp}_{filename}
                    const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(snapshot.ref);

                    // Update Data
                    // fieldPath is like "appData.tourism.coverImage"
                    // We need to set the value. 
                    // Safe approach: execute assignment
                    // Since we use global appData, we can use a Function or eval (careful) or walk the object.
                    // Let's use a helper to set value by path.
                    setByPath(window.appData, fieldPath.replace('appData.', ''), url);

                    // Update Input UI
                    // Find input with the onclick listener or matching value? 
                    // Actually renderEditor will refresh everything with new value.
                    renderEditor();

                    alert("Imagen subida correctamente!");

                } catch (error) {
                    console.error("Upload failed", error);
                    alert("Error al subir imagen: " + error.message);
                } finally {
                    if (btn) btn.innerHTML = '<i data-lucide="upload" class="w-4 h-4"></i> Subir';
                    if (window.lucide) window.lucide.createIcons();
                }
            };
            input.click();
        }

        function setByPath(obj, path, value) {
            const parts = path.split('.');
            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                // If array index
                if (parts[i].includes('[')) {
                    const [name, idx] = parts[i].split('[');
                    const index = parseInt(idx.replace(']', ''));
                    current = current[name][index];
                } else {
                    current = current[parts[i]];
                }
            }
            const lastPart = parts[parts.length - 1];
            if (lastPart.includes('[')) {
                const [name, idx] = lastPart.split('[');
                const index = parseInt(idx.replace(']', ''));
                current[name][index] = value;
            } else {
                current[lastPart] = value;
            }
        }

        // Initialize App
        (async function init() {
            const editor = document.getElementById('editor-area');
            if (editor) editor.innerHTML = '<div class="text-center p-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i><p>Cargando datos...</p></div>';

            window.appData = await DB.get();
            switchTab(window.currentTab);
        })();

        // --- GLOBAL FUNCTIONS ---

        window.switchTab = function (tab) {
            window.currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('bg-amber-500', 'text-white');
                b.classList.add('bg-white', 'text-gray-800');
                if (b.dataset.tab === tab) {
                    b.classList.remove('bg-white', 'text-gray-800');
                    b.classList.add('bg-amber-500', 'text-white');
                }
            });
            renderEditor();
        }

        window.renderEditor = function () {
            const container = document.getElementById('editor-area');
            const data = window.appData[window.currentTab];

            if (!data) {
                container.innerHTML = `<p class="text-red-500">Error: No se encontraron datos para la pesta√±a ${window.currentTab}. Intenta reiniciar los datos.</p>`;
                return;
            }

            let html = '';

            // Master Toggle (Active/Inactive)
            html += `
                <div class="mb-6 p-4 bg-stone-50 rounded-xl border border-stone-200 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">Visible en App</h3>
                        <p class="text-xs text-gray-500">Activar o desactivar este servicio para los hu√©spedes</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" 
                               ${data.active ? 'checked' : ''} 
                               onchange="appData.${window.currentTab}.active = this.checked; saveChanges();" 
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                    </label>
                </div>
            `;

            // Common Fields
            if (data.desc !== undefined && window.currentTab !== 'minibar' && window.currentTab !== 'laundry') html += field('Descripci√≥n', `appData.${window.currentTab}.desc`, data.desc, 'textarea');
            if (data.info !== undefined && window.currentTab === 'laundry') html += field('Informaci√≥n', `appData.${window.currentTab}.info`, data.info, 'textarea');
            if (data.schedule !== undefined) html += field('Horario', `appData.${window.currentTab}.schedule`, data.schedule);
            if (data.ext !== undefined) html += field('Extensi√≥n Telef√≥nica', `appData.${window.currentTab}.ext`, data.ext);
            if (data.surcharge !== undefined) html += field('Suplemento (‚Ç¨)', `appData.${window.currentTab}.surcharge`, data.surcharge);

            // Special: Tourism
            if (window.currentTab === 'tourism') {

                // 1. Cabecera (Videos y Visuales) - Toggleable
                html += `<details class="bg-blue-50 rounded-xl border border-blue-200 mb-6 group" open>
                            <summary class="font-bold text-lg p-4 text-blue-800 cursor-pointer list-none flex justify-between items-center outline-none">
                                <span>Portada & Multimedia</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-blue-500 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="p-4 pt-0 border-t border-blue-200/50 mt-2">
                                <div class="mb-4">
                                    ${field('Video de Cabecera (Fondo Portada)', `appData.tourism.videoUrl`, data.videoUrl)}
                                    <p class="text-xs text-gray-500 -mt-2 mb-2">Video de fondo a pantalla completa. Usar formato embed de YouTube.</p>
                                </div>
                                <div class="mb-4">
                                    ${field('Imagen de Portada (Opcional - Reemplaza al Video)', `appData.tourism.coverImage`, data.coverImage || '')}
                                    <p class="text-xs text-gray-500 -mt-2 mb-2">Si se a√±ade una imagen, sustituir√° al video de fondo. Ideal para m√≥viles o carga r√°pida.</p>
                                </div>
                                <div class="mb-4">
                                    ${field('Video Promocional (Miniatura)', `appData.tourism.videoUrlPromo`, data.videoUrlPromo || '')}
                                    <p class="text-xs text-gray-500 -mt-2 mb-2">Se muestra en peque√±o junto al texto introductorio.</p>
                                </div>
                            </div>
                         </details>`;

                // 2. Contenido de Texto - Toggleable
                html += `<details class="bg-amber-50 rounded-xl border border-amber-200 mb-6 group">
                            <summary class="font-bold text-lg p-4 text-amber-800 cursor-pointer list-none flex justify-between items-center outline-none">
                                <span>Texto Introductorio General</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-amber-500 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="p-4 pt-0 border-t border-amber-200/50 mt-2">
                                ${field('Descripci√≥n de la Gu√≠a', `appData.tourism.desc`, data.desc || '', 'textarea')}
                            </div>
                         </details>`;

                // 3. Excursions Manager (Accordion Style)
                html += `<div class="mt-8 border-t pt-6">
                            <h3 class="font-bold text-lg text-stone-700 mb-4 flex items-center justify-between">
                                <span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5"></i> Experiencias y Excursiones</span>
                                <span class="text-xs font-normal text-gray-400">${(data.excursions || []).length} experiencias</span>
                            </h3>
                            
                            <div class="space-y-3">
                                ${(data.excursions || []).map((exc, idx) => `
                                    <details class="border rounded-xl bg-white shadow-sm group hover:shadow-md transition duration-200 ${!exc.active ? 'opacity-70 bg-gray-50' : ''}">
                                        
                                        <!-- Header / Summary -->
                                        <summary class="p-4 cursor-pointer list-none flex justify-between items-center outline-none">
                                            <div class="flex items-center gap-3">
                                                <div class="w-2 h-2 rounded-full ${exc.active ? 'bg-emerald-500' : 'bg-gray-300'}"></div>
                                                <span class="font-bold text-stone-800 text-lg">${exc.title || 'Nueva Excursi√≥n'}</span>
                                                <span class="font-mono text-xs bg-stone-100 px-2 py-0.5 rounded text-stone-500 hidden sm:inline-block">#${exc.id || 'id'}</span>
                                            </div>
                                            <div class="flex items-center gap-4">
                                                <span class="text-xs text-gray-400 group-open:hidden max-w-[150px] truncate">${exc.subtitle || ''}</span>
                                                <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180"></i>
                                            </div>
                                        </summary>

                                        <!-- Body -->
                                        <div class="p-4 pt-0 border-t border-gray-100 mt-2">
                                            
                                            <!-- Controls Row -->
                                            <div class="flex justify-between items-center mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                <div class="flex items-center gap-4">
                                                    <label class="flex items-center cursor-pointer gap-2 select-none">
                                                        <span class="text-xs font-bold text-gray-600 uppercase">Visible en App</span>
                                                        <div class="relative inline-flex items-center">
                                                            <input type="checkbox" ${exc.active !== false ? 'checked' : ''} onchange="appData.tourism.excursions[${idx}].active = this.checked; renderEditor();" class="sr-only peer">
                                                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                                                        </div>
                                                    </label>
                                                </div>
                                                <div class="flex gap-2">
                                                     <button onclick="deleteExcursion(${idx})" class="text-xs flex items-center gap-1 text-red-400 hover:text-red-600 px-3 py-1.5 hover:bg-red-50 rounded transition">
                                                        <i data-lucide="trash-2" class="w-3 h-3"></i> Eliminar
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div class="space-y-4">
                                                    ${field('T√≠tulo', `appData.tourism.excursions[${idx}].title`, exc.title)}
                                                    ${field('Subt√≠tulo', `appData.tourism.excursions[${idx}].subtitle`, exc.subtitle || '')}
                                                    ${field('ID Texto (Slug)', `appData.tourism.excursions[${idx}].id`, exc.id)}
                                                </div>
                                                <div class="space-y-4">
                                                     <div class="mb-4">
                                                        <label class="block text-sm font-bold text-gray-600 mb-1">Color Tema (Categor√≠a Visual)</label>
                                                        <select onchange="appData.tourism.excursions[${idx}].color = this.value" class="w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-amber-500 outline-none">
                                                            <option value="amber" ${exc.color === 'amber' ? 'selected' : ''}>üî∏ √Åmbar (Cultura/General)</option>
                                                            <option value="emerald" ${exc.color === 'emerald' ? 'selected' : ''}>üåø Esmeralda (Naturaleza)</option>
                                                            <option value="rose" ${exc.color === 'rose' ? 'selected' : ''}>üé≠ Rosa (Teatro/Arte)</option>
                                                            <option value="blue" ${exc.color === 'blue' ? 'selected' : ''}>üíß Azul (Agua/Relax)</option>
                                                            <option value="indigo" ${exc.color === 'indigo' ? 'selected' : ''}>üåå √çndigo (Nocturno)</option>
                                                        </select>
                                                    </div>
                                                    ${field('Tipo (Etiqueta)', `appData.tourism.excursions[${idx}].type`, exc.type || '')}
                                                </div>
                                            </div>
                                            
                                            <!-- Descriptions -->
                                            <div class="grid grid-cols-1 gap-6 mb-6">
                                                <div>
                                                    ${field('Descripci√≥n Corta (Resumen para listado)', `appData.tourism.excursions[${idx}].description`, exc.description || exc.shortDesc || '', 'textarea')}
                                                </div>
                                                
                                                <div class="relative">
                                                     <label class="block text-sm font-bold text-amber-700 mb-1 flex justify-between">
                                                        <span>Descripci√≥n Larga (Detalle de la p√°gina)</span>
                                                        <span class="text-[10px] font-normal text-amber-600 bg-amber-50 px-2 py-0.5 rounded">Formato Autom√°tico (P√°rrafos)</span>
                                                     </label>
                                                     <textarea rows="10" 
                                                        onchange="appData.tourism.excursions[${idx}].fullDesc = this.value" 
                                                        class="w-full p-3 border border-amber-200 rounded-lg font-mono text-sm text-stone-700 bg-amber-50/30 focus:bg-white focus:ring-2 focus:ring-amber-500 transition shadow-inner" 
                                                        placeholder="Escribe aqu√≠ toda la informaci√≥n detallada...">${exc.fullDesc || ''}</textarea>
                                                </div>
                                            </div>

                                            <!-- Images & Media -->
                                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
                                                <h4 class="font-bold text-sm text-gray-500 uppercase mb-3 border-b pb-1">Multimedia</h4>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                    ${field('Imagen Listado (URL)', `appData.tourism.excursions[${idx}].image`, exc.image || '')}
                                                    ${field('Imagen Hero (Cabecera Detalle)', `appData.tourism.excursions[${idx}].heroImage`, exc.heroImage || exc.image || '')}
                                                </div>

                                                <div class="mb-4">
                                                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Galer√≠a de Im√°genes (URLs separadas por coma)</label>
                                                    <textarea rows="3" onchange="appData.tourism.excursions[${idx}].gallery = this.value.split(',').map(s => s.trim()).filter(Boolean)" class="w-full p-2 border rounded text-xs text-blue-600 font-mono">${(exc.gallery || []).join(', ')}</textarea>
                                                </div>

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    ${field('Video URL (YouTube Embed)', `appData.tourism.excursions[${idx}].videoUrl`, exc.videoUrl || '')}
                                                    ${field('Enlace Externo (Web)', `appData.tourism.excursions[${idx}].linkUrl`, exc.linkUrl || '')}
                                                </div>
                                            </div>

                                        </div>
                                    </details>
                                `).join('')}
                            </div>

                            <button onclick="addExcursion()" class="mt-8 w-full py-4 bg-stone-800 text-white rounded-xl font-bold hover:bg-stone-700 transition flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i data-lucide="plus-circle" class="w-6 h-6"></i> 
                                <span>A√±adir Nueva Experiencia</span>
                            </button>
                        </div>`;
            }

            // Special: Spa
            if (window.currentTab === 'spa') {
                html += `<div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                            <h3 class="font-bold text-lg mb-4 text-cyan-600 border-b border-cyan-200 pb-2">Contenido Visual</h3>
                            <div class="mb-4">
                                ${field('Imagen de Cabecera (URL)', `appData.spa.headerImage`, data.headerImage || 'Imagenes/spa.jpg')}
                                <div class="mt-2 h-32 bg-gray-100 rounded-lg overflow-hidden border border-gray-200 relative">
                                    <img src="${data.headerImage || 'Imagenes/spa.jpg'}" class="w-full h-full object-cover opacity-80">
                                    <p class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 font-bold bg-white/50 backdrop-blur-sm opacity-0 hover:opacity-100 transition">Vista previa</p>
                                </div>
                            </div>
                            <div class="mb-4">
                                ${field('Video Presentaci√≥n (URL YouTube)', `appData.spa.videoUrl`, data.videoUrl || '')}
                            </div>
                         </div>`;

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Tarifas</h3>`;
                html += field('Semana', `appData.spa.prices.week`, data.prices.week);
                html += field('Fin de Semana', `appData.spa.prices.weekend`, data.prices.weekend);
                html += field('Gorro', `appData.spa.prices.cap`, data.prices.cap);
                html += field('Chanclas', `appData.spa.prices.flipflops`, data.prices.flipflops);

                // Gallery Manager
                html += `<div class="mt-8 border-t pt-6">
                            <h3 class="font-bold text-lg text-stone-700 mb-4 flex items-center gap-2">
                                <i data-lucide="images" class="w-5 h-5"></i> Galer√≠a de Fotos
                            </h3>
                            <div id="spa-gallery-list" class="space-y-3">
                                ${(data.images || []).map((img, idx) => `
                                    <div class="flex gap-2 items-center bg-white p-2 rounded shadow-sm group">
                                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 cursor-grab handle-img hover:text-cyan-500"></i>
                                        <div class="w-16 h-10 bg-gray-100 rounded overflow-hidden shrink-0 border border-gray-200">
                                            <img src="${img}" class="w-full h-full object-cover">
                                        </div>
                                        <input value="${img}" onchange="appData.spa.images[${idx}] = this.value; renderEditor();" class="flex-1 text-sm bg-transparent border-b border-transparent focus:border-cyan-500 focus:outline-none" placeholder="URL de la imagen">
                                        <button onclick="deleteSpaImage(${idx})" class="p-2 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="addSpaImage()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-cyan-500 hover:text-cyan-500 transition flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> A√±adir Foto
                            </button>
                         </div>`;
            }

            // Special: Info
            if (window.currentTab === 'info') {
                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Recepci√≥n</h3>`;
                html += field('Texto', `appData.info.reception.text`, data.reception.text, 'textarea');
                html += field('Tel√©fono', `appData.info.reception.phone`, data.reception.phone);

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Desayuno</h3>`;
                html += field('Horario Semana', `appData.info.breakfast.schedule_week`, data.breakfast.schedule_week);
                html += field('Horario Finde', `appData.info.breakfast.schedule_weekend`, data.breakfast.schedule_weekend);
                html += field('Precio', `appData.info.breakfast.price`, data.breakfast.price);

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Piscina & Gym</h3>`;
                html += field('Piscina Desc.', `appData.info.pool.text`, data.pool.text);
                html += field('Piscina Horario', `appData.info.pool.schedule`, data.pool.schedule);
                html += field('Gym Desc.', `appData.info.gym.text`, data.gym.text);
                html += field('Gym Horario Sem.', `appData.info.gym.schedule_week`, data.gym.schedule_week);

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Parking</h3>`;
                html += field('Texto', `appData.info.parking.text`, data.parking.text, 'textarea');

                html += `<h3 class="font-bold mt-6 mb-4 border-b pb-2">Otros Horarios</h3>`;
                html += field('Rest. Comidas', `appData.info.restaurant.schedule_lunch`, data.restaurant.schedule_lunch);
                html += field('Rest. Cenas', `appData.info.restaurant.schedule_dinner`, data.restaurant.schedule_dinner);
                html += field('Cafeter√≠a', `appData.info.cafeteria.schedule`, data.cafeteria.schedule);
                html += field('Room Service', `appData.info.roomService.schedule`, data.roomService.schedule);
            }

            // Categories & Items (Restaurant, Room Service, Minibar)
            if (window.currentTab === 'restaurante') {
                const menu = data.dailyMenu || { active: false, price: '', date: '', includes: '', starters: [], mains: [] };

                // Ensure data structure
                if (!window.appData.restaurante.dailyMenu) {
                    window.appData.restaurante.dailyMenu = {
                        active: false,
                        price: "20,00",
                        date: "",
                        includes: "Incluido postre, pan, y una bebida\n(Agua, refresco, copa de vino o ca√±a)",
                        starters: [],
                        mains: []
                    };
                }

                html += `
                    <div class="mt-8 mb-8 border-2 border-stone-800 rounded-xl p-6 bg-stone-50">
                        <div class="flex justify-between items-center mb-6 border-b border-stone-200 pb-4">
                            <h3 class="font-bold text-2xl font-serif text-stone-900">Configuraci√≥n Men√∫ del D√≠a</h3>
                             
                             <div class="flex gap-4">
                                <!-- Helper: Activar Carta -->
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           ${data.showCarta !== false ? 'checked' : ''} 
                                           onchange="appData.restaurante.showCarta = this.checked; saveChanges();" 
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-stone-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-900">Mostrar Carta</span>
                                </label>

                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           ${menu.active ? 'checked' : ''} 
                                           onchange="appData.restaurante.dailyMenu.active = this.checked; saveChanges();" 
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-stone-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-stone-800"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-900">Activar Men√∫</span>
                                </label>
                             </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4 relative">
                            <div>
                                ${field('Fecha (Texto)', `appData.restaurante.dailyMenu.date`, menu.date)}
                                <button onclick="setTodayDate()" class="absolute top-[34px] right-[52%] text-xs bg-stone-200 hover:bg-stone-300 px-2 py-1 rounded">Hoy</button>
                            </div>
                            <div class="relative">
                                ${field('Precio (‚Ç¨)', `appData.restaurante.dailyMenu.price`, menu.price)}
                                <a href="https://translate.google.com/" target="_blank" class="absolute top-[34px] right-2 text-xs text-amber-600 hover:underline flex items-center gap-1"><i data-lucide="languages" class="w-3 h-3"></i> Traducir</a>
                            </div>
                        </div>

                        <div class="mb-4">
                             <label class="block text-sm font-bold text-gray-600 mb-1">Primeros Platos (Uno por l√≠nea)</label>
                             <textarea rows="6" onchange="updateMenuArray('starters', this.value)" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-stone-500 font-mono text-sm">${(menu.starters || []).join('\n')}</textarea>
                        </div>

                        <div class="mb-4">
                             <label class="block text-sm font-bold text-gray-600 mb-1">Segundos Platos (Uno por l√≠nea)</label>
                             <textarea rows="6" onchange="updateMenuArray('mains', this.value)" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-stone-500 font-mono text-sm">${(menu.mains || []).join('\n')}</textarea>
                        </div>
                        
                         <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-600 mb-1">Incluye (Texto al pie)</label>
                            <textarea rows="2" onchange="appData.restaurante.dailyMenu.includes = this.value" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-stone-500">${menu.includes || ''}</textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded text-xs text-blue-800">
                            <strong>Nota:</strong> Los n√∫meros entre par√©ntesis, ej: (1/4), se mostrar√°n autom√°ticamente en la app como al√©rgenos.
                        </div>
                    </div>
                `;
            }

            // Categories & Items (Restaurant, Room Service, Minibar)
            if (data.categories && window.currentTab !== 'laundry') {
                html += `<div id="sortable-categories">`;
                data.categories.forEach((cat, catIdx) => {
                    html += `
                        <div class="mt-8 border p-4 rounded-xl bg-gray-50 relative group sortable-category" data-id="${catIdx}">
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 cursor-grab handle-cat hover:text-amber-500"></i>
                                <input value="${cat.name}" onchange="appData.${window.currentTab}.categories[${catIdx}].name = this.value" class="font-bold text-lg text-amber-600 bg-transparent border-b border-transparent focus:border-amber-500 focus:outline-none flex-1">
                                <button onclick="deleteCategory(${catIdx})" class="text-xs text-red-300 hover:text-red-500 transition px-2 py-1 rounded hover:bg-red-50" title="Eliminar Categor√≠a">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <div class="space-y-4 sortable-items" data-cat="${catIdx}">
                                ${cat.items.map((item, itemIdx) => itemRow(window.currentTab, catIdx, itemIdx, item)).join('')}
                            </div>

                            <button onclick="addItem(${catIdx})" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-amber-500 hover:text-amber-500 transition flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> A√±adir Plato
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Special: Laundry Categories
            if (data.categories && window.currentTab === 'laundry') {
                html += `<div id="sortable-categories">`;
                data.categories.forEach((cat, catIdx) => {
                    html += `
                        <div class="mt-8 border p-4 rounded-xl bg-gray-50 relative group sortable-category" data-id="${catIdx}">
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 cursor-grab handle-cat hover:text-blue-500"></i>
                                <input value="${cat.name}" onchange="appData.laundry.categories[${catIdx}].name = this.value" class="font-bold text-lg text-blue-600 bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none flex-1">
                                <button onclick="deleteCategory(${catIdx})" class="text-xs text-red-300 hover:text-red-500 transition px-2 py-1 rounded hover:bg-red-50" title="Eliminar Categor√≠a">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-400 mb-2 px-2 pl-8">
                                <div class="col-span-1"></div>
                                <div class="col-span-5">Prenda</div>
                                <div class="col-span-3 text-right">Lav+Plan</div>
                                <div class="col-span-3 text-right">Plancha</div>
                            </div>
                            <div class="space-y-2 sortable-items" data-cat="${catIdx}">
                                ${cat.items.map((item, itemIdx) => itemRowLaundry(catIdx, itemIdx, item)).join('')}
                            </div>
                            <button onclick="addLaundryItem(${catIdx})" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-blue-500 hover:text-blue-500 transition flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> A√±adir Prenda
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Simple Items List (Cafeteria)
            if (data.items && window.currentTab !== 'laundry') {
                html += `
                    <div class="mt-8 border p-4 rounded-xl bg-gray-50">
                        <h3 class="font-bold text-lg text-amber-600 mb-2">Art√≠culos</h3>
                        <div class="space-y-4 sortable-list" id="simple-items-list">
                            ${data.items.map((item, itemIdx) => itemRowSimple(window.currentTab, itemIdx, item)).join('')}
                        </div>
                        <button onclick="addItemSimple()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 font-bold hover:border-amber-500 hover:text-amber-500 transition flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> A√±adir Art√≠culo
                        </button>
                    </div>
                `;
            }

            // ADD CATEGORY BUTTON (New)
            if (data.categories) {
                html += `
                    <div class="mt-8 border-t pt-6">
                        <button onclick="addCategory()" class="w-full py-3 bg-stone-100 rounded-xl text-stone-600 font-bold hover:bg-stone-200 transition flex items-center justify-center gap-2">
                             <i data-lucide="folder-plus" class="w-5 h-5"></i> Crear Nueva Categor√≠a
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
            lucide.createIcons();
            initSortable();
        }

        window.initSortable = function () {
            // Sort Categories
            const catContainer = document.getElementById('sortable-categories');
            if (catContainer) {
                new Sortable(catContainer, {
                    animation: 150,
                    handle: '.handle-cat',
                    onEnd: function (evt) {
                        const tab = window.currentTab;
                        const arr = window.appData[tab].categories;
                        // Move item in array and Update
                        const [movedItem] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, movedItem);
                        renderEditor(); // Re-render to update indices
                    }
                });
            }

            // Sort Items within Categories
            document.querySelectorAll('.sortable-items').forEach(el => {
                const catIdx = el.dataset.cat;
                new Sortable(el, {
                    animation: 150,
                    handle: '.handle-item',
                    onEnd: function (evt) {
                        const tab = window.currentTab;
                        if (!window.appData[tab].categories[catIdx]) return; // Safety check

                        const arr = window.appData[tab].categories[catIdx].items;
                        const [movedItem] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, movedItem);
                        renderEditor();
                    }
                });
            });

            // Sort Simple List
            const simpleList = document.getElementById('simple-items-list');
            if (simpleList) {
                new Sortable(simpleList, {
                    animation: 150,
                    handle: '.handle-item',
                    onEnd: function (evt) {
                        const tab = window.currentTab;
                        const arr = window.appData[tab].items;
                        const [movedItem] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, movedItem);
                        renderEditor();
                    }
                });
            }
        }

        window.field = function (label, path, value, type = 'text') {
            const safeValue = value === undefined || value === null ? '' : value;
            return `
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-600 mb-1">${label}</label>
                    ${type === 'textarea'
                    ? `<textarea onchange="${path} = this.value" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-amber-500 options-input" rows="4">${safeValue}</textarea>`
                    : `<input type="${type}" value="${safeValue}" onchange="${path} = this.value" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-amber-500 options-input">`
                }
                </div>
            `;
        }

        // --- ROW TEMPLATES ---

        window.itemRow = function (tab, catIdx, itemIdx, item) {
            return `
                <div class="flex gap-2 items-start bg-white p-2 rounded shadow-sm group/item">
                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 mt-3 cursor-grab handle-item hover:text-amber-500"></i>
                    <div class="flex-1 space-y-2">
                        <input placeholder="Nombre" value="${item.name}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].name = this.value" class="w-full font-bold border-b mb-1 focus:outline-none focus:border-amber-500">
                        <div class="flex gap-2">
                             <input placeholder="Descripci√≥n" value="${item.desc || ''}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].desc = this.value" class="flex-1 text-sm text-gray-500 focus:outline-none focus:text-gray-800 border-b border-transparent hover:border-gray-200">
                             <input placeholder="Al√©rgenos (ej: 1,4)" value="${item.allergens || ''}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].allergens = this.value" class="w-32 text-xs text-gray-500 focus:outline-none focus:text-amber-600 border-b border-transparent hover:border-amber-200 text-right" title="C√≥digos de al√©rgenos">
                        </div>
                        <div class="flex gap-2 items-center">
                            <i data-lucide="image" class="w-3 h-3 text-gray-300"></i>
                            <input placeholder="URL Imagen (opcional)" value="${item.image || ''}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].image = this.value" class="flex-1 text-xs text-stone-400 focus:outline-none focus:text-blue-600 border-b border-transparent hover:border-blue-200">
                        </div>
                    </div>
                    <div class="w-24">
                        <input type="text" value="${item.price}" onchange="appData.${tab}.categories[${catIdx}].items[${itemIdx}].price = this.value" class="w-full p-1 border rounded text-right font-mono focus:ring-2 focus:ring-amber-500" placeholder="0.00">
                    </div>
                    <button onclick="deleteItem(${catIdx}, ${itemIdx})" class="p-2 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        window.itemRowSimple = function (tab, itemIdx, item) {
            return `
                <div class="flex gap-2 items-start bg-white p-2 rounded shadow-sm group/item">
                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 mt-3 cursor-grab handle-item hover:text-amber-500"></i>
                    <div class="flex-1">
                        <input placeholder="Nombre" value="${item.name}" onchange="appData.${tab}.items[${itemIdx}].name = this.value" class="w-full font-bold border-b mb-1 focus:outline-none focus:border-amber-500">
                    </div>
                    <div class="w-24">
                        <input type="text" value="${item.price}" onchange="appData.${tab}.items[${itemIdx}].price = this.value" class="w-full p-1 border rounded text-right font-mono focus:ring-2 focus:ring-amber-500" placeholder="0.00">
                    </div>
                    <button onclick="deleteItemSimple(${itemIdx})" class="p-2 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        window.itemRowLaundry = function (catIdx, itemIdx, item) {
            return `
                <div class="grid grid-cols-12 gap-1 items-center bg-white p-2 rounded shadow-sm">
                    <div class="col-span-1 flex justify-center">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 cursor-grab handle-item hover:text-blue-500"></i>
                    </div>
                    <div class="col-span-5">
                        <input value="${item.name}" onchange="appData.laundry.categories[${catIdx}].items[${itemIdx}].name = this.value" class="w-full font-bold text-sm bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none" placeholder="Nombre">
                    </div>
                    <div class="col-span-3">
                        <input value="${item.priceWash}" onchange="appData.laundry.categories[${catIdx}].items[${itemIdx}].priceWash = this.value" class="w-full text-right text-xs font-mono bg-blue-50/50 rounded px-1 py-1 border border-transparent focus:border-blue-500" type="text" placeholder="Lav">
                    </div>
                    <div class="col-span-2">
                        <input value="${item.priceIron}" onchange="appData.laundry.categories[${catIdx}].items[${itemIdx}].priceIron = this.value" class="w-full text-right text-xs font-mono bg-stone-50 rounded px-1 py-1 border border-transparent focus:border-blue-500" type="text" placeholder="Pla">
                    </div>
                    <div class="col-span-1 text-center">
                         <button onclick="deleteLaundryItem(${catIdx}, ${itemIdx})" class="p-1 text-gray-300 hover:text-red-500 transition" title="Eliminar">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---

        window.addCategory = function () {
            const name = prompt("Nombre de la nueva categor√≠a:");
            if (name) {
                window.appData[window.currentTab].categories.push({
                    name: name,
                    items: []
                });
                renderEditor();
            }
        }

        window.deleteCategory = function (catIdx) {
            if (confirm("¬øEst√°s seguro de eliminar esta categor√≠a y todos sus √≠tems?")) {
                window.appData[window.currentTab].categories.splice(catIdx, 1);
                renderEditor();
            }
        }

        window.addItem = function (catIdx) {
            const newItem = { name: "Nuevo Plato", desc: "Descripci√≥n...", price: "0.00" };
            window.appData[window.currentTab].categories[catIdx].items.push(newItem);
            renderEditor();
        }

        window.deleteItem = function (catIdx, itemIdx) {
            if (confirm('¬øEliminar este plato?')) {
                window.appData[window.currentTab].categories[catIdx].items.splice(itemIdx, 1);
                renderEditor();
            }
        }

        window.addLaundryItem = function (catIdx) {
            const newItem = { name: "Nueva Prenda", priceWash: "0,00", priceIron: "0,00" };
            window.appData.laundry.categories[catIdx].items.push(newItem);
            renderEditor();
        }

        window.deleteLaundryItem = function (catIdx, itemIdx) {
            if (confirm('¬øEliminar esta prenda?')) {
                window.appData.laundry.categories[catIdx].items.splice(itemIdx, 1);
                renderEditor();
            }
        }

        window.addItemSimple = function () {
            const newItem = { name: "Nuevo Art√≠culo", price: "0.00" };
            window.appData[window.currentTab].items.push(newItem);
            renderEditor();
        }

        window.deleteItemSimple = function (itemIdx) {
            if (confirm('¬øEliminar este art√≠culo?')) {
                window.appData[window.currentTab].items.splice(itemIdx, 1);
                renderEditor();
            }
        }

        window.saveChanges = async function () {
            const btn = document.querySelector('button[onclick="saveChanges()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> Guardando...';

            try {
                // Save Main Data
                await DB.save(window.appData);

                // Save History if we are in Restaurant tab

                if (window.currentTab === 'restaurante' && window.appData.restaurante.dailyMenu.active) {
                    await DB.saveMenuHistory(window.appData.restaurante.dailyMenu);
                }

                alert('¬°Cambios guardados! Sincronizado con la nube.');
            } catch (err) {
                console.error(err);
                alert('Error al guardar: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        window.setTodayDate = function () {
            const date = new Date();
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Format: "Ciudad Real, 11 de Enero de 2026"
            const str = `Ciudad Real, ${date.getDate()} de ${months[date.getMonth()]} de ${date.getFullYear()}`;

            // Update Data
            if (window.appData && window.appData.restaurante && window.appData.restaurante.dailyMenu) {
                window.appData.restaurante.dailyMenu.date = str;
            }

            // Update Input View: Find input that syncs with dailyMenu.date
            // Re-render essentially
            renderEditor();
        }

        window.updateMenuArray = function (key, value) {
            // Split by newline and remove empty lines
            const arr = value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            window.appData.restaurante.dailyMenu[key] = arr;
        }

        window.resetData = function () {
            if (confirm('¬øReiniciar todos los datos a f√°brica?')) {
                window.appData = DB.reset();
                renderEditor();
            }
        }
        window.addSpaImage = function () {
            const url = prompt("URL de la nueva imagen:");
            if (url) {
                if (!window.appData.spa.images) window.appData.spa.images = [];
                window.appData.spa.images.push(url);
                renderEditor();
            }
        }

        window.deleteSpaImage = function (idx) {
            if (confirm("¬øBorrar esta imagen?")) {
                window.appData.spa.images.splice(idx, 1);
                renderEditor();
            }
        }

        window.addExcursion = function () {
            const id = prompt("ID √∫nico para la excursi√≥n (ej: tablas-daimiel):");
            if (!id) return;

            // Check uniqueness
            if (window.appData.tourism.excursions.some(e => e.id === id)) {
                alert("Ya existe una excursi√≥n con ese ID.");
                return;
            }

            const newExc = {
                id: id.toLowerCase().replace(/\s+/g, '-'),
                title: "Nueva Excursi√≥n",
                subtitle: "",
                shortDesc: "Descripci√≥n corta...",
                fullDesc: "<p>Descripci√≥n detallada...</p>",
                image: "https://via.placeholder.com/400x300",
                heroImage: "https://via.placeholder.com/800x600",
                videoUrl: "",
                gallery: [],
                color: "amber"
            };

            window.appData.tourism.excursions.push(newExc);
            renderEditor();
        }

        window.deleteExcursion = function (idx) {
            if (confirm("¬øSeguro que quieres eliminar esta excursi√≥n? Esta acci√≥n no se puede deshacer.")) {
                window.appData.tourism.excursions.splice(idx, 1);
                renderEditor();
            }
        }
    </script>
</body>

</html>